name: Build photos and deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ImageMagick
        run: sudo apt-get update && sudo apt-get install -y imagemagick

      - name: Generate thumbs + full (web)
        run: |
          mkdir -p assets/photos/thumbs assets/photos/full
          rm -f assets/photos/thumbs/* assets/photos/full/*

          shopt -s nullglob
          for f in assets/originals/*.{jpg,jpeg,JPG,JPEG}; do
            base=$(basename "$f")
            name="${base%.*}"

            magick "$f" -auto-orient -strip -resize '2560x2560>' -quality 82 \
              "assets/photos/full/${name}.jpg"

            magick "$f" -auto-orient -strip -resize '640x640>' -quality 75 \
              "assets/photos/thumbs/${name}.jpg"
          done

      - name: Write _data/photos.yml for Jekyll
        run: |
          mkdir -p _data
          echo "photos:" > _data/photos.yml
          for f in assets/photos/full/*.jpg; do
            b=$(basename "$f")
            n="${b%.*}"
            echo "  - name: \"${n}\"" >> _data/photos.yml
            echo "    file: \"${b}\"" >> _data/photos.yml
          done

      - name: Deploy to gh-pages (without originals)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: .
          exclude_assets: assets/originals
